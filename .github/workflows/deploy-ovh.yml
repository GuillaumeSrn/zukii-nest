name: Deploy to OVH VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to OVH VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          script: |
            cd ~/zukii-app
            
            echo "🚀 DÉPLOIEMENT PROGRESSIF C2.2.4 - Démarrage..."
            
            # === ÉTAPE 1: BASE DE DONNÉES ===
            echo "📊 ÉTAPE 1: Déploiement de la base de données..."
            docker compose up -d db
            sleep 5
            
            # === ÉTAPE 2: BACKEND NESTJS ===
            echo "🔧 ÉTAPE 2: Déploiement du backend NestJS..."
            docker compose pull backend
            docker compose up -d backend
            sleep 10
            
            # === ÉTAPE 3: FRONTEND ANGULAR ===
            echo "🌐 ÉTAPE 3: Déploiement du frontend Angular..."
            docker compose pull frontend
            docker compose up -d frontend
            sleep 5
            
            # === VALIDATION FINALE ===
            echo "🔍 Vérification des services..."
            docker compose ps
            
            echo "🎉 DÉPLOIEMENT PROGRESSIF C2.2.4 TERMINÉ !"
            echo "🌐 Application accessible sur: http://${{ secrets.OVH_HOST }}"