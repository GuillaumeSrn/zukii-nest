name: Deploy to OVH VPS

on:
  workflow_run:
    workflows: ["Code Validation Pipeline"]
    types: [completed]
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    if: ${{ github.event.workflow_run.conclusion == 'success' }}
    
    steps:
      - name: Deploy Backend to OVH VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          script: |
            cd ~/zukii-app
            echo "ğŸ”„ DÃ©ploiement progressif sur OVH VPS..."
            
            # 1. Base de donnÃ©es
            echo "ğŸ“Š DÃ©ploiement de la base de donnÃ©es..."
            docker compose up -d db
            
            # Attendre que la base soit prÃªte
            echo "â³ Attente de la disponibilitÃ© de la base de donnÃ©es..."
            timeout 60 bash -c 'until docker compose exec -T db pg_isready -U $DB_USERNAME; do sleep 2; done' || exit 1
            echo "âœ… Base de donnÃ©es prÃªte"
            
            # 2. Service Python
            echo "ğŸ DÃ©ploiement du service Python..."
            docker compose pull python-service
            docker compose up -d python-service
            
            # Attendre que le service Python soit prÃªt (avec tolÃ©rance pour le mode offline)
            echo "â³ Attente de la disponibilitÃ© du service Python..."
            timeout 60 bash -c 'until docker compose exec -T python-service sh -c "curl -sf http://localhost:8000/health" >/dev/null 2>&1; do sleep 2; done' || echo "âš ï¸ Service Python non accessible (mode offline possible)"
            echo "âœ… Service Python prÃªt"
            
            # 3. Backend NestJS
            echo "ğŸ”§ DÃ©ploiement du backend NestJS..."
            docker compose pull backend
            docker compose up -d backend
            
            # Attendre que le backend soit prÃªt
            echo "â³ Attente de la disponibilitÃ© du backend..."
            timeout 60 bash -c 'until docker compose exec -T backend sh -c "curl -sf http://localhost:3000/health" >/dev/null 2>&1; do sleep 2; done' || exit 1
            echo "âœ… Backend prÃªt"
            
            # 4. Frontend Angular
            echo "ğŸŒ DÃ©ploiement du frontend Angular..."
            docker compose pull frontend
            docker compose up -d frontend
            
            # Attendre que le frontend soit prÃªt
            echo "â³ Attente de la disponibilitÃ© du frontend..."
            timeout 60 bash -c 'until docker compose exec -T frontend sh -c "curl -sf http://localhost/" >/dev/null 2>&1; do sleep 2; done' || exit 1
            echo "âœ… Frontend prÃªt"
            
            # Validation finale
            echo "ğŸ” Validation finale des services..."
            echo "ğŸ“Š Base de donnÃ©es: $(docker compose exec -T db pg_isready -U $DB_USERNAME && echo 'OK' || echo 'KO')"
            echo "ğŸ”§ Backend: $(docker compose exec -T backend sh -c "curl -sf http://localhost:3000/health" >/dev/null 2>&1 && echo 'OK' || echo 'KO')"
            echo "ğŸŒ Frontend: $(docker compose exec -T frontend sh -c "curl -sf http://localhost/" >/dev/null 2>&1 && echo 'OK' || echo 'KO')"
            
            echo "ğŸ‰ DÃ©ploiement progressif rÃ©ussi sur OVH VPS!"
            echo "ğŸŒ Application accessible sur: http://${{ secrets.OVH_HOST }}"