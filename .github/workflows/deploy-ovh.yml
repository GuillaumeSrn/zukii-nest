name: Deploy to OVH VPS

on:
  push:
    branches: [main]

jobs:
  deploy:
    runs-on: ubuntu-latest
    steps:
      - name: Deploy to OVH VPS
        uses: appleboy/ssh-action@v1.0.0
        with:
          host: ${{ secrets.OVH_HOST }}
          username: ${{ secrets.OVH_USER }}
          key: ${{ secrets.OVH_SSH_KEY }}
          script: |
            cd ~/zukii-app
            
            echo "ğŸš€ DÃ‰PLOIEMENT PROGRESSIF C2.2.4 - DÃ©marrage..."
            
            # === Ã‰TAPE 1: BASE DE DONNÃ‰ES ===
            echo "ğŸ“Š Ã‰TAPE 1: DÃ©ploiement de la base de donnÃ©es..."
            docker compose up -d db
            sleep 5
            
            # === Ã‰TAPE 2: BACKEND NESTJS ===
            echo "ğŸ”§ Ã‰TAPE 2: DÃ©ploiement du backend NestJS..."
            docker compose pull backend
            docker compose up -d backend
            sleep 10
            
            # === Ã‰TAPE 3: FRONTEND ANGULAR ===
            echo "ğŸŒ Ã‰TAPE 3: DÃ©ploiement du frontend Angular..."
            docker compose pull frontend
            docker compose up -d frontend
            sleep 5
            
            # === VALIDATION FINALE ===
            echo "ğŸ” VÃ©rification des services..."
            docker compose ps
            
            echo "ğŸ‰ DÃ‰PLOIEMENT PROGRESSIF C2.2.4 TERMINÃ‰ !"
            echo "ğŸŒ Application accessible sur: http://${{ secrets.OVH_HOST }}"