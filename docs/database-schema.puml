@startuml Database_Model_Zukii
!define TABLE(name,desc) class name as "desc" << (T,#FFAAAA) >>
!define PK(x) <u>x</u>
!define FK(x) <i>x</i>
!define IDX(x) <color:blue>x</color>

title Modèle de base de données - Zukii (Vision Complète)

TABLE(User, "User") {
  PK(id): UUID
  IDX(email): VARCHAR(255) UNIQUE NOT NULL
  password_hash: VARCHAR(255) NOT NULL
  display_name: VARCHAR(100) NOT NULL
  FK(status_id): VARCHAR NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Board, "Board") {
  PK(id): UUID
  title: VARCHAR(200) NOT NULL
  description: TEXT
  FK(owner_id): UUID NOT NULL
  FK(status_id): VARCHAR NOT NULL
  background_color: VARCHAR(7) DEFAULT '#FFFFFF'
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Status, "Status") {
  PK(id): VARCHAR PRIMARY KEY
  IDX(category_name): (category, name) UNIQUE
  category: VARCHAR(50) NOT NULL
  name: VARCHAR(50) NOT NULL
  is_active: BOOLEAN DEFAULT TRUE
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(BoardMember, "BoardMember") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  FK(user_id): UUID NOT NULL
  IDX(unique_membership): (board_id, user_id) UNIQUE
  permission_level: ENUM('view', 'edit', 'admin') DEFAULT 'view'
  FK(status_id): VARCHAR NOT NULL
  FK(updated_by): UUID NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Invitation, "Invitation") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  email: VARCHAR(255) NOT NULL
  permission_level: ENUM('view', 'edit', 'admin') NOT NULL
  IDX(invitation_token): VARCHAR(128) UNIQUE NOT NULL
  FK(invited_by): UUID NOT NULL
  expires_at: TIMESTAMP NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(SuperBlock, "SuperBlock") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  title: VARCHAR(200) NOT NULL
  color: VARCHAR(7) DEFAULT '#6366f1'
  collapsed: BOOLEAN DEFAULT FALSE
  display_order: INTEGER DEFAULT 0
  FK(created_by): UUID NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Block, "Block") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  FK(created_by): UUID NOT NULL
  block_type: ENUM('text', 'file', 'analysis') NOT NULL
  title: VARCHAR(200)
  position_x: INTEGER NULL
  position_y: INTEGER NULL
  width: INTEGER DEFAULT 200
  height: INTEGER DEFAULT 150
  z_index: INTEGER DEFAULT 0
  FK(content_id): UUID NOT NULL
  FK(super_block_id): UUID NULL
  zone_type: VARCHAR(50) NULL
  FK(status_id): VARCHAR NOT NULL
  FK(last_modified_by): UUID NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
  IDX(board_spatial): (board_id, position_x, position_y)
  IDX(content_lookup): (content_id, block_type)
  IDX(super_block): (super_block_id)
}

TABLE(BlockRelation, "BlockRelation") {
  PK(id): UUID
  FK(source_block_id): UUID NOT NULL
  FK(target_block_id): UUID NOT NULL
  relation_type: ENUM('generated_from', 'comment_on', 'references', 'derived_from') NOT NULL
  FK(created_by): UUID NOT NULL
  IDX(unique_relation): (source_block_id, target_block_id, relation_type) UNIQUE
  IDX(source_relations): (source_block_id)
  IDX(target_relations): (target_block_id)
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(TextContent, "TextContent") {
  PK(id): UUID
  content: TEXT NOT NULL
  format_type: ENUM('plain', 'markdown', 'html') DEFAULT 'plain'
  word_count: INTEGER DEFAULT 0
  FK(status_id): VARCHAR NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(FileContent, "FileContent") {
  PK(id): UUID
  file_name: VARCHAR(255) NOT NULL
  mime_type: VARCHAR(100) NOT NULL
  file_size: BIGINT NOT NULL
  base64_data: TEXT NOT NULL
  md5_hash: VARCHAR(32) NOT NULL
  file_type: VARCHAR(50) DEFAULT 'csv'
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(AnalysisContent, "AnalysisContent") {
  PK(id): UUID
  analysis_type: VARCHAR(100) NOT NULL
  result_data: JSONB NOT NULL
  FK(source_file_id): UUID NULL
  execution_status: ENUM('pending', 'running', 'completed', 'failed') DEFAULT 'pending'
  execution_time: INTEGER
  error_message: TEXT
  FK(status_id): VARCHAR NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
  IDX(analysis_search): (analysis_type, execution_status)
}

TABLE(AnalysisTemplate, "AnalysisTemplate") {
  PK(id): UUID
  name: VARCHAR(200) NOT NULL
  description: TEXT
  analysis_type: VARCHAR(100) NOT NULL
  prompt_template: TEXT NOT NULL
  parameters: JSONB DEFAULT '{}'
  input_requirements: JSONB
  is_active: BOOLEAN DEFAULT TRUE
  FK(status_id): VARCHAR NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
  IDX(analysis_type_active): (analysis_type, is_active)
}

User ||--o{ Board : "owner_id"
User ||--o{ BoardMember : "user_id"
User ||--o{ SuperBlock : "created_by"
User ||--o{ Block : "created_by"
User ||--o{ Block : "last_modified_by"
User ||--o{ BlockRelation : "created_by"
User ||--o{ Invitation : "invited_by"

Board ||--o{ BoardMember : "board_id"
Board ||--o{ SuperBlock : "board_id"
Board ||--o{ Block : "board_id"
Board ||--o{ Invitation : "board_id"

SuperBlock ||--o{ Block : "super_block_id"

Block ||--o{ BlockRelation : "source_block_id"
Block ||--o{ BlockRelation : "target_block_id"

Status ||--o{ User : "status_id"
Status ||--o{ Board : "status_id"
Status ||--o{ BoardMember : "status_id"
Status ||--o{ Block : "status_id"
Status ||--o{ TextContent : "status_id"
Status ||--o{ AnalysisContent : "status_id"
Status ||--o{ AnalysisTemplate : "status_id"

Block ||--|| TextContent : "content_id (type=text)"
Block ||--|| FileContent : "content_id (type=file)"
Block ||--|| AnalysisContent : "content_id (type=analysis)"

FileContent ||--o{ AnalysisContent : "source_file_id"
AnalysisTemplate ||--o{ AnalysisContent : "analysis_type"

@enduml 