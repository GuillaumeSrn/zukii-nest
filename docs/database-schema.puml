@startuml Database_Model_Zukii_MVP_Hybrid
!define TABLE(name,desc) class name as "desc" << (T,#FFAAAA) >>
!define PK(x) <u>x</u>
!define FK(x) <i>x</i>

title Modèle de base de données - Zukii

' === CORE ENTITIES ===
TABLE(User, "User") {
  PK(id): UUID
  email: VARCHAR(255) UNIQUE NOT NULL
  password_hash: VARCHAR(255) NOT NULL
  display_name: VARCHAR(100) NOT NULL
  FK(status_id): UUID NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Role, "Role") {
  PK(id): UUID
  name: VARCHAR(50) UNIQUE NOT NULL
  is_admin: BOOLEAN DEFAULT FALSE
  created_at: TIMESTAMP DEFAULT NOW()
}

TABLE(UserRole, "UserRole") {
  PK(id): UUID
  FK(user_id): UUID NOT NULL
  FK(role_id): UUID NOT NULL
  assigned_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Board, "Board") {
  PK(id): UUID
  title: VARCHAR(200) NOT NULL
  description: TEXT
  FK(owner_id): UUID NOT NULL
  FK(status_id): UUID NOT NULL
  ' Propriétés interactives essentielles
  background_color: VARCHAR(7) DEFAULT '#FFFFFF'
  canvas_width: INTEGER DEFAULT 2000
  canvas_height: INTEGER DEFAULT 1500
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
  deleted_at: TIMESTAMP NULL
}

TABLE(BoardMember, "BoardMember") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  FK(user_id): UUID NOT NULL
  permission_level: ENUM('view', 'edit', 'admin') NOT NULL
  joined_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Invitation, "Invitation") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  email: VARCHAR(255) NOT NULL
  permission_level: ENUM('view', 'edit', 'admin') NOT NULL
  invitation_token: VARCHAR(100) UNIQUE NOT NULL
  invited_by: UUID NOT NULL
  expires_at: TIMESTAMP NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
}

TABLE(Block, "Block") {
  PK(id): UUID
  FK(board_id): UUID NOT NULL
  FK(created_by): UUID NOT NULL
  block_type: ENUM('text', 'file', 'analysis') NOT NULL
  title: VARCHAR(200)
  ' Position et taille interactives
  position_x: INTEGER NOT NULL
  position_y: INTEGER NOT NULL
  width: INTEGER DEFAULT 300
  height: INTEGER DEFAULT 200
  z_index: INTEGER DEFAULT 0
  FK(status_id): UUID NOT NULL
  created_at: TIMESTAMP DEFAULT NOW()
  updated_at: TIMESTAMP DEFAULT NOW()
  deleted_at: TIMESTAMP NULL
}

TABLE(BlockContent, "BlockContent") {
  PK(id): UUID
  FK(block_id): UUID NOT NULL UNIQUE
  ' Pour TextBlock - simple mais flexible
  text_content: TEXT
  text_color: VARCHAR(7) DEFAULT '#000000'
  ' Pour FileBlock - métadonnées essentielles
  file_name: VARCHAR(255)
  s3_key: VARCHAR(500)
  s3_bucket: VARCHAR(100)
  file_size: BIGINT
  file_type: VARCHAR(50)
  FK(uploaded_by): UUID
  ' Pour AnalysisBlock
  analysis_type: VARCHAR(100)
  result_data: JSONB
}

TABLE(Status, "Status") {
  PK(id): UUID
  category: VARCHAR(50) NOT NULL
  name: VARCHAR(50) NOT NULL
  is_active: BOOLEAN DEFAULT TRUE
  created_at: TIMESTAMP DEFAULT NOW()
}

' === RELATIONS ===
User ||--o{ UserRole
Role ||--o{ UserRole
User ||--o{ Board
User ||--o{ BoardMember
Board ||--o{ BoardMember
Board ||--o{ Invitation
Board ||--o{ Block
User ||--o{ Block
Block ||--o{ BlockContent

Status ||--o{ User
Status ||--o{ Board
Status ||--o{ Block

note right of Board
  Canvas interactif avec limites.
  Couleur de fond personnalisable.
end note

note right of Block
  z_index pour superposition.
  Dimensions redimensionnables.
  3 types via ENUM.
end note

note right of BlockContent
  Métadonnées S3 essentielles.
  JSONB flexible pour analyses.
end note

note right of Invitation
  Système d'invitation
  Token temporaire + expiration.
end note

@enduml 